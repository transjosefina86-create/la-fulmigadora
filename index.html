<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Fulmigadora - Sistema de Gesti贸n v3.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        :root {
            --orange-main: #ea580c;
            --slate-dark: #020617;
            --glass-base: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--slate-dark); 
            color: #f8fafc; 
            margin: 0;
            min-height: 100vh;
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            z-index: -10;
            background-size: cover;
            background-position: center;
            opacity: 0.25;
        }

        .glass-card {
            background: var(--glass-base);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 2rem;
        }

        .input-custom {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            transition: all 0.2s;
        }

        .input-custom:focus {
            outline: none;
            border-color: var(--orange-main);
            box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.2);
        }

        .btn-primary {
            background: var(--orange-main);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyC0jIDWwzWFgugZpY8mhOFZEh-ZAUhed7Y",
            authDomain: "la-fulmigadora.firebaseapp.com",
            projectId: "la-fulmigadora",
            storageBucket: "la-fulmigadora.appspot.com",
            messagingSenderId: "235458080625",
            appId: "1:235458080625:web:61ea831d6620f1ecde10d0"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const App = () => {
            const [autorizado, setAutorizado] = useState(false);
            const [password, setPassword] = useState('');
            const [temporadas, setTemporadas] = useState([]);
            const [tempActiva, setTempActiva] = useState(null);
            const [filtroChofer, setFiltroChofer] = useState('');
            const [porcentajesDinamicos, setPorcentajesDinamicos] = useState({});
            const [fondo, setFondo] = useState(() => JSON.parse(localStorage.getItem('fulmi_bg_v3') || '{"url":null}'));
            
            const [nuevoTr, setNuevoTr] = useState({ 
                empresa: '', campo: '', lote: '', chofer: '', hectareas: '', precio: '', iva: '0' 
            });

            const inputsRef = useRef([]);

            useEffect(() => {
                auth.signInAnonymously().catch(console.error);
                const unsub = db.collection('temporadas').orderBy('fechaCreacion', 'desc').onSnapshot(snap => {
                    setTemporadas(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsub();
            }, []);

            // NAVEGACIN CON ENTER
            const handleKeyDown = (e, index, tId) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (index < 6) {
                        inputsRef.current[index + 1].focus();
                    } else {
                        guardarTr(tId);
                    }
                }
            };

            const guardarTr = async (id) => {
                if (!nuevoTr.chofer || !nuevoTr.precio) return;
                
                const esAdelanto = !nuevoTr.empresa && !nuevoTr.campo;
                const netoVal = esAdelanto ? parseFloat(nuevoTr.precio) : (parseFloat(nuevoTr.hectareas || 0) * parseFloat(nuevoTr.precio || 0));
                const totalVal = esAdelanto ? netoVal : netoVal * (1 + (parseFloat(nuevoTr.iva || 0) / 100));

                const registro = {
                    ...nuevoTr,
                    id: Date.now().toString(),
                    neto: netoVal,
                    total: totalVal,
                    esAdelanto,
                    fecha: new Date().toLocaleDateString(),
                    cobrado: false,
                    pagado: false
                };

                await db.collection('temporadas').doc(id).update({
                    trabajos: firebase.firestore.FieldValue.arrayUnion(registro)
                });

                setNuevoTr({ empresa: '', campo: '', lote: '', chofer: nuevoTr.chofer, hectareas: '', precio: '', iva: '0' });
                inputsRef.current[0].focus();
            };

            // MESA DE CLCULO DE LIQUIDACIN PROFESIONAL
            const mesaLiquidacion = useMemo(() => {
                if (!tempActiva || !filtroChofer) return null;
                const t = temporadas.find(x => x.id === tempActiva);
                const filtrados = t?.trabajos?.filter(tr => 
                    tr.chofer.toLowerCase().includes(filtroChofer.toLowerCase())
                ) || [];

                const empresas = {};
                const adelantos = [];
                
                filtrados.forEach(tr => {
                    if (tr.esAdelanto) {
                        adelantos.push(tr);
                    } else {
                        if (!empresas[tr.empresa]) empresas[tr.empresa] = { neto: 0, has: 0 };
                        empresas[tr.empresa].neto += tr.neto;
                        empresas[tr.empresa].has += parseFloat(tr.hectareas || 0);
                    }
                });

                let totalComisiones = 0;
                Object.keys(empresas).forEach(emp => {
                    const p = porcentajesDinamicos[emp] || 0;
                    totalComisiones += (empresas[emp].neto * (p / 100));
                });

                const totalAdelantos = adelantos.reduce((s, c) => s + c.neto, 0);

                return { 
                    empresas, 
                    adelantos, 
                    totalComisiones, 
                    totalAdelantos, 
                    saldoFinal: totalComisiones - totalAdelantos 
                };
            }, [temporadas, tempActiva, filtroChofer, porcentajesDinamicos]);

            if (!autorizado) {
                return (
                    <div className="h-screen flex items-center justify-center bg-slate-950">
                        <div className="glass-card p-10 w-80 text-center shadow-2xl">
                            <h2 className="text-2xl font-black mb-6 text-orange-500 italic">LA FULMIGADORA</h2>
                            <input type="password" placeholder="CLAVE" className="input-custom text-center mb-4" 
                                   onChange={e => e.target.value === '1986' && setAutorizado(true)} />
                            <p className="text-[10px] opacity-30 uppercase tracking-widest">Panel de Control</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-6 relative">
                    <div className="bg-overlay" style={{backgroundImage: `url(${fondo.url})`}}></div>
                    
                    <header className="glass-card p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h1 className="text-xl font-black text-orange-500 italic uppercase">Gesti贸n de Choferes</h1>
                        <div className="w-full md:w-72">
                            <input type="text" placeholder=" Buscar Chofer para Liquidar..." 
                                   className="input-custom border-orange-500/30"
                                   onChange={e => setFiltroChofer(e.target.value)} />
                        </div>
                    </header>

                    {/* MESA DE CLCULO DINMICA */}
                    {mesaLiquidacion && filtroChofer && (
                        <div className="glass-card p-8 mb-8 border-orange-500/40 animate-fade">
                            <div className="flex items-center gap-3 mb-6">
                                <i className="fas fa-file-invoice-dollar text-orange-500 text-2xl"></i>
                                <h2 className="text-lg font-black uppercase">Liquidaci贸n: {filtroChofer}</h2>
                            </div>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-3">
                                    <p className="text-[10px] font-black opacity-40 uppercase mb-2">Desglose por Empresa:</p>
                                    {Object.keys(mesaLiquidacion.empresas).map(emp => (
                                        <div key={emp} className="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                                            <div>
                                                <p className="font-black text-orange-500 uppercase">{emp}</p>
                                                <p className="text-xs opacity-60">{mesaLiquidacion.empresas[emp].has} Hect谩reas Totales</p>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <div className="text-right">
                                                    <p className="text-[10px] opacity-40">NETO</p>
                                                    <p className="font-bold">${mesaLiquidacion.empresas[emp].neto.toLocaleString()}</p>
                                                </div>
                                                <div className="flex items-center bg-orange-600/20 px-3 py-2 rounded-xl border border-orange-500/30">
                                                    <input type="number" className="bg-transparent w-8 text-center font-black text-orange-500 outline-none" 
                                                           placeholder="0" value={porcentajesDinamicos[emp] || ''} 
                                                           onChange={e => setPorcentajesDinamicos({...porcentajesDinamicos, [emp]: e.target.value})} />
                                                    <span className="text-[10px] font-black text-orange-500">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="bg-black/40 p-6 rounded-[2rem] border border-white/5 flex flex-col justify-between">
                                    <div className="space-y-4">
                                        <div className="flex justify-between text-sm">
                                            <span className="opacity-50">Subtotal Comisi贸n:</span>
                                            <span className="font-black text-green-400">${mesaLiquidacion.totalComisiones.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="opacity-50">Adelantos:</span>
                                            <span className="font-black text-red-400">-${mesaLiquidacion.totalAdelantos.toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <div className="mt-8 pt-4 border-t border-white/10 text-right">
                                        <p className="text-[10px] font-black opacity-40 uppercase">Saldo a Pagar</p>
                                        <p className="text-3xl font-black text-white">${mesaLiquidacion.saldoFinal.toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="space-y-6">
                        {temporadas.map(t => (
                            <div key={t.id} className="glass-card overflow-hidden">
                                <div className="p-6 flex justify-between items-center cursor-pointer hover:bg-white/5" 
                                     onClick={() => setTempActiva(tempActiva === t.id ? null : t.id)}>
                                    <span className="font-black uppercase tracking-widest">{t.nombre}</span>
                                    <i className={`fas fa-chevron-${tempActiva === t.id ? 'up text-orange-500' : 'down opacity-20'}`}></i>
                                </div>

                                {tempActiva === t.id && (
                                    <div className="p-6 space-y-6 bg-black/20">
                                        {/* FORMULARIO */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                                            <input ref={el => inputsRef.current[0] = el} type="text" placeholder="Empresa" className="input-custom" value={nuevoTr.empresa} onChange={e=>setNuevoTr({...nuevoTr, empresa:e.target.value})} onKeyDown={e=>handleKeyDown(e, 0, t.id)} />
                                            <input ref={el => inputsRef.current[1] = el} type="text" placeholder="Campo" className="input-custom" value={nuevoTr.campo} onChange={e=>setNuevoTr({...nuevoTr, campo:e.target.value})} onKeyDown={e=>handleKeyDown(e, 1, t.id)} />
                                            <input ref={el => inputsRef.current[2] = el} type="text" placeholder="Lote" className="input-custom" value={nuevoTr.lote} onChange={e=>setNuevoTr({...nuevoTr, lote:e.target.value})} onKeyDown={e=>handleKeyDown(e, 2, t.id)} />
                                            <input ref={el => inputsRef.current[3] = el} type="text" placeholder="Chofer" className="input-custom" value={nuevoTr.chofer} onChange={e=>setNuevoTr({...nuevoTr, chofer:e.target.value})} onKeyDown={e=>handleKeyDown(e, 3, t.id)} />
                                            <input ref={el => inputsRef.current[4] = el} type="number" placeholder="Has" className="input-custom" value={nuevoTr.hectareas} onChange={e=>setNuevoTr({...nuevoTr, hectareas:e.target.value})} onKeyDown={e=>handleKeyDown(e, 4, t.id)} />
                                            <input ref={el => inputsRef.current[5] = el} type="number" placeholder="$ Neto/Adelanto" className="input-custom" value={nuevoTr.precio} onChange={e=>setNuevoTr({...nuevoTr, precio:e.target.value})} onKeyDown={e=>handleKeyDown(e, 5, t.id)} />
                                            <input ref={el => inputsRef.current[6] = el} type="number" placeholder="IVA %" className="input-custom" value={nuevoTr.iva} onChange={e=>setNuevoTr({...nuevoTr, iva:e.target.value})} onKeyDown={e=>handleKeyDown(e, 6, t.id)} />
                                            <button onClick={()=>guardarTr(t.id)} className="btn-primary p-3 rounded-xl lg:col-span-7">Guardar Registro</button>
                                        </div>

                                        {/* TABLA */}
                                        <div className="overflow-x-auto custom-scrollbar">
                                            <table className="w-full text-xs text-left border-separate border-spacing-y-2">
                                                <thead className="opacity-30 uppercase text-[10px] font-black">
                                                    <tr>
                                                        <th className="px-4">Detalle</th>
                                                        <th className="px-4 text-right">Importe Neto</th>
                                                        <th className="px-4 text-center">Estado</th>
                                                        <th className="px-4"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {t.trabajos?.filter(x => x.chofer.toLowerCase().includes(filtroChofer.toLowerCase())).map(tr => (
                                                        <tr key={tr.id} className={`glass-card ${tr.esAdelanto ? 'bg-yellow-500/5' : ''}`}>
                                                            <td className="p-4 rounded-l-2xl">
                                                                <div className="font-black uppercase tracking-tighter">
                                                                    {tr.esAdelanto ? <span className="text-yellow-500">Adelanto Chofer</span> : <span className="text-orange-500">{tr.empresa} - {tr.lote}</span>}
                                                                </div>
                                                                <div className="text-[10px] opacity-40 uppercase">{tr.fecha} | {tr.chofer}</div>
                                                            </td>
                                                            <td className="p-4 text-right font-black">
                                                                ${tr.neto.toLocaleString()}
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                <div className="flex justify-center gap-2">
                                                                    <button className={`w-8 h-8 rounded-lg border ${tr.cobrado ? 'bg-green-600' : 'opacity-10'}`}><i className="fas fa-check"></i></button>
                                                                    <button className={`w-8 h-8 rounded-lg border ${tr.pagado ? 'bg-blue-600' : 'opacity-10'}`}><i className="fas fa-check"></i></button>
                                                                </div>
                                                            </td>
                                                            <td className="p-4 rounded-r-2xl text-right">
                                                                <button onClick={async() => {
                                                                    const n = t.trabajos.filter(x => x.id !== tr.id);
                                                                    await db.collection('temporadas').doc(t.id).update({ trabajos: n });
                                                                }} className="text-white/5 hover:text-red-500"><i className="fas fa-trash"></i></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
    </script>
</body>
</html>
